<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì²« ë²ˆì§¸ ë°© íƒˆì¶œ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --ink:#2b1b0e; --rule:#b89a6a; }
  *{box-sizing:border-box}
  body{
    margin:0; padding:40px;
    font-family:'Noto Serif KR',serif; line-height:1.65; color:var(--ink);
    background:url('/images/parchment-bg.jpg') center/cover fixed no-repeat;
  }
  .wrap{ max-width:720px; margin:0 auto; background:rgba(255,255,255,.72); border-radius:10px; padding:26px 22px; }
  h1{ text-align:center; font-size:26px; margin:0 0 18px }
  p{ margin:0 0 10px }
  .note{ font-size:13px; color:#7a5c24; margin-top:8px }

  .comments{ margin-top:26px }
  .comments h2{ font-size:20px; margin:0 0 10px }

  .comment{ display:flex; gap:8px; align-items:flex-start; padding:10px 0; border-bottom:1px solid var(--rule);
            overflow-wrap:anywhere; word-break:break-word; white-space:pre-wrap; }
  .comment strong{ color:#4a2c1f }

  textarea{ width:100%; height:90px; resize:vertical }
  button{ padding:7px 14px; cursor:pointer; border:1px solid var(--rule); background:#f7efe2 }
  .admin-hint{ font-size:12px; color:#866; opacity:.8; text-align:right; margin-top:6px }
  .delBtn{ margin-left:auto; background:#7b2a2a; color:#fff; border:none; padding:4px 8px; border-radius:4px }

  .pager{ display:flex; gap:6px; justify-content:center; margin-top:14px; flex-wrap:wrap }
  .pager button{ padding:4px 8px; border:1px solid var(--rule); background:#fff7e8 }
  .pager .on{ background:#e8d3aa; font-weight:600 }
  .hidden{ display:none }
</style>
</head>
<body>
  <div class="wrap">
    <h1>ì¶•í•˜ë“œë¦½ë‹ˆë‹¤. ë‹¹ì‹ ì€ ì²« ë²ˆì§¸ ë°©ì„ ì„±ê³µì ìœ¼ë¡œ íƒˆì¶œí•˜ì…¨ìŠµë‹ˆë‹¤.</h1>
    <p>í•˜ì§€ë§Œ ë‹¹ì‹ ë„ ì•„ì‹œë‹¤ì‹œí”¼ ë³¸ ê²Œì„ì€ ê·¸ë¦¬ í˜¸ë½í˜¸ë½í•œ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.</p>
    <p>ë‹¹ì‹ ê»˜ì„  ê°íˆ ê°ë‹¹í•  ìˆ˜ ì—†ëŠ” ì¡´ì¬ë“¤ì´ ì¦ë¹„í•˜ê³ , ëª©ìˆ¨ì„ ìœ„íƒœë¡­ê²Œ ë§Œë“œëŠ” ì•…ì˜ë“¤ì´ ê°€ë“í•©ë‹ˆë‹¤.</p>
    <p>ë‹¹ì‹ ì€ ê·¸ì¤‘ ë‹¨ ì²« ë²ˆì§¸ ë°©ì„ íƒˆì¶œí•œ ê²ƒì…ë‹ˆë‹¤.</p>
    <p>ê·¸ëŸ¼ì—ë„ ì²« ê´€ë¬¸ì„ ì´ê²¨ë‚¸ ì—¬ëŸ¬ë¶„ì—ê²Œ í™˜í˜¸ì˜ ë°•ìˆ˜ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.</p>
    <p>ì–´ë””ê¹Œì§€ ë„ë‹¬í•˜ì‹¤ ìˆ˜ ìˆì„ì§„ ëª¨ë¥´ê² ìœ¼ë‚˜, ì•„ë“í•œ ì € ì¶œêµ¬ë¥¼ í–¥í•´ í˜ê» ë…¸ë ¥í•´ ë³´ì‹œê¸¸ ë°”ë¼ëŠ” ë°”ì…ë‹ˆë‹¤.</p>
    <p>ì²« ë²ˆì§¸ ë°©ì„ íƒˆì¶œí•˜ì‹  íƒˆì¶œì ë¶„ë“¤ì€ ì•„ë˜ ë³´ì´ëŠ” ì½”ë©˜íŠ¸ë€ì— ìì‹ ì˜ ë§ì„ ë‹´ì„ ìê²©ì´ ì£¼ì–´ì§‘ë‹ˆë‹¤.</p>
    <p>ë¬´ìŠ¨ ë§ì„ í•´ë„ ë³¸ì¸ì˜ ììœ ì…ë‹ˆë‹¤. ë‹¨, ì‚¬íšŒì ìœ¼ë¡œ í†µìš©ë  ìˆ˜ ì—†ëŠ” ë¶€ì ì ˆ ë°œì–¸ì´ë‚˜ ì§€ë‚˜ì¹œ ì—¼ì„¸ì£¼ì˜ëŠ” í˜ë„í‹°ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <p class="note"><b>â€» ì½”ë©˜íŠ¸ëŠ” 1ì¸ 1íšŒë§Œ ì‘ì„± ê°€ëŠ¥í•˜ë©°, ì‘ì„± í›„ ìˆ˜ì •Â·ì‚­ì œëŠ” ë¶ˆê°€í•©ë‹ˆë‹¤.</b><br>
      ë‹¨ ìš´ì˜ìëŠ” ê´€ë¦¬ ì°¨ì›ì—ì„œ ì‚­ì œí•  ìˆ˜ ìˆìœ¼ë©°, ì´ ê²½ìš° ë²ˆí˜¸ëŠ” ë‹¹ê²¨ì§‘ë‹ˆë‹¤.</p>

    <div class="comments">
      <h2>ì½”ë©˜íŠ¸ë€</h2>

      <div id="commentList"></div>
      <div class="pager" id="pager"></div>

      <form id="commentForm" onsubmit="return false" style="margin-top:12px">
        <textarea id="commentText" placeholder="ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 300ì)"></textarea><br>
        <button id="submitBtn">ì‘ì„±</button>
      </form>

      <div id="adminHint" class="admin-hint hidden">
        ê´€ë¦¬ì ëª¨ë“œ ON â€” ëŒ“ê¸€ ì˜† ğŸ—‘ ë²„íŠ¼ìœ¼ë¡œ ì‚­ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤
      </div>
    </div>
  </div>

<script>
  // ===== ìƒíƒœ =====
  const ADMIN_TOKEN_KEY = 'admin_token';
  let isAdmin = !!sessionStorage.getItem(ADMIN_TOKEN_KEY);
  const listEl = document.getElementById('commentList');
  const pagerEl = document.getElementById('pager');
  const formEl = document.getElementById('commentForm');
  const textEl = document.getElementById('commentText');
  const submitEl = document.getElementById('submitBtn');
  const adminHintEl = document.getElementById('adminHint');

  const PAGE_LIMIT = 20;
  let curPage = 1, totalPages = 1;

  const esc = s => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function setAdmin(on){
    isAdmin = !!on;
    adminHintEl.classList.toggle('hidden', !isAdmin);
    render();
  }

  // ê´€ë¦¬ì ë‹¨ì¶•í‚¤ ë³€ê²½: Ctrl+Alt+K (ON), Ctrl+Alt+L (OFF)
  window.addEventListener('keydown', e=>{
    if(e.ctrlKey && e.altKey && (e.key==='k'||e.key==='K')){
      const pw = prompt('ìš´ì˜ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      if(!pw) return;
      sessionStorage.setItem(ADMIN_TOKEN_KEY, pw);
      setAdmin(true);
      alert('ê´€ë¦¬ì ëª¨ë“œê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤.');
    }
    if(e.ctrlKey && e.altKey && (e.key==='l'||e.key==='L')){
      sessionStorage.removeItem(ADMIN_TOKEN_KEY);
      setAdmin(false);
      alert('ê´€ë¦¬ì ëª¨ë“œê°€ êº¼ì¡ŒìŠµë‹ˆë‹¤.');
    }
  });

  // ===== API =====
  async function fetchList(page=1){
    const r = await fetch(`/api/comments?page=${page}&limit=${PAGE_LIMIT}`);
    if(!r.ok) throw new Error('ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
    return r.json();
  }

  async function render(page=curPage){
    try{
      const data = await fetchList(page);
      curPage = data.page;
      totalPages = Math.max(1, Math.ceil(data.total / data.limit));

      // ëª©ë¡
      listEl.innerHTML = data.items.map(c => `
        <div class="comment">
          <div><strong>[${esc(c.by)}]</strong> ${esc(c.text)}</div>
          ${isAdmin ? `<button class="delBtn" data-id="${c.id}" title="ì‚­ì œ">ğŸ—‘</button>` : ''}
        </div>
      `).join('');

      if(isAdmin){
        listEl.querySelectorAll('.delBtn').forEach(btn=>{
          btn.addEventListener('click', ()=> adminDelete(parseInt(btn.dataset.id,10)));
        });
      }

      // í˜ì´ì €
      const btn = (p,l=''+p,on=false)=>`<button ${on?'class="on"':''} data-p="${p}">${l}</button>`;
      const parts = [];
      const start = Math.max(1, curPage-2), end = Math.min(totalPages, curPage+2);
      if(curPage>1) parts.push(btn(curPage-1,'ì´ì „'));
      for(let p=start;p<=end;p++) parts.push(btn(p, String(p), p===curPage));
      if(curPage<totalPages) parts.push(btn(curPage+1,'ë‹¤ìŒ'));
      pagerEl.innerHTML = parts.join('');
      pagerEl.querySelectorAll('button').forEach(b=>{
        b.addEventListener('click', ()=> render(parseInt(b.dataset.p,10)));
      });

    }catch(err){
      listEl.innerHTML = `<p>ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${esc(err.message||String(err))}</p>`;
      pagerEl.innerHTML = '';
    }
  }

  // ì‘ì„±
  formEl.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const text = textEl.value.trim();
    if(!text) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
    submitEl.disabled = true;
    try{
      const r = await fetch('/api/comments', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ text })
      });
      const data = await r.json().catch(()=>({}));
      if(r.ok){
        formEl.innerHTML = '<p>ì½”ë©˜íŠ¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
        render(totalPages); // ë§ˆì§€ë§‰ í˜ì´ì§€ ê°±ì‹ 
      }else{
        alert(data.error || 'ë“±ë¡ ì‹¤íŒ¨');
        submitEl.disabled = false;
      }
    }catch(err){
      alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      submitEl.disabled = false;
    }
  });

  // ì‚­ì œ(ê´€ë¦¬ì)
  async function adminDelete(id){
    if(!confirm(`íƒˆì¶œì ${id}ì˜ ì½”ë©˜íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”? (ë²ˆí˜¸ëŠ” ë‹¹ê²¨ì§‘ë‹ˆë‹¤)`)) return;
    const token = sessionStorage.getItem(ADMIN_TOKEN_KEY) || '';
    const r = await fetch('/api/comments', {
      method:'DELETE',
      headers:{
        'Content-Type':'application/json',
        'Authorization':'Bearer ' + token
      },
      body: JSON.stringify({ id })
    });
    if(r.ok){
      alert('ì‚­ì œ ì™„ë£Œ');
      // í˜„ì¬ í˜ì´ì§€ì— í•­ëª©ì´ ì‚¬ë¼ì ¸ ë¹„ë©´ ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
      render(Math.max(1, curPage - 0));
    }else{
      alert('ì‚­ì œ ì‹¤íŒ¨: ' + (await r.text()));
    }
  }

  // init
  if(isAdmin) adminHintEl.classList.remove('hidden');
  render(1);
</script>
</body>
</html>
