<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì²« ë²ˆì§¸ ë°© íƒˆì¶œ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --ink:#2b1b0e; --rule:#b89a6a; --muted:#7a5c24 }
    *{ box-sizing:border-box }
    body{
      margin:0; padding:40px 16px;
      font-family:'Noto Serif KR',serif; line-height:1.65; color:var(--ink);
      background:url('/images/parchment-bg.jpg') center/cover fixed no-repeat;
    }
    .wrap{ max-width:760px; margin:0 auto; background:rgba(255,255,255,.72); border-radius:10px; padding:26px 22px }
    h1{ text-align:center; font-size:26px; margin:0 0 18px }
    p{ margin:0 0 10px }
    .note{ font-size:13px; color:var(--muted); margin-top:8px }
    .comments{ margin-top:26px }
    .comments h2{ font-size:20px; margin:0 0 12px }

    .comment{
      padding:10px 0; border-bottom:1px solid var(--rule);
      overflow-wrap:anywhere; word-break:break-word;
    }
    .comment strong{ color:#4a2c1f }

    textarea{ width:100%; height:120px; resize:vertical; padding:10px }
    button{ padding:8px 14px; cursor:pointer; border:1px solid var(--rule); background:#f7efe2; border-radius:6px }
    button[disabled]{ opacity:.6; cursor:default }
    .row{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap }

    /* í˜ì´ì§€ë„¤ì´ì…˜ */
    .pager{ display:flex; align-items:center; gap:8px; margin:12px 0 }
    .pager button{ padding:6px 10px }

    .admin-hint{ font-size:12px; color:#866; opacity:.85; text-align:right; margin-top:6px }
    .delBtn{ margin-left:auto; background:#7b2a2a; color:#fff; border:none; padding:4px 8px; border-radius:4px }

    /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
    html,body{ overflow-x:hidden }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ì¶•í•˜ë“œë¦½ë‹ˆë‹¤. ë‹¹ì‹ ì€ ì²« ë²ˆì§¸ ë°©ì„ ì„±ê³µì ìœ¼ë¡œ íƒˆì¶œí•˜ì…¨ìŠµë‹ˆë‹¤.</h1>
    <p>í•˜ì§€ë§Œ ë‹¹ì‹ ë„ ì•„ì‹œë‹¤ì‹œí”¼ ë³¸ ê²Œì„ì€ ê·¸ë¦¬ í˜¸ë½í˜¸ë½í•œ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.</p>
    <p>ë‹¹ì‹ ê»˜ì„  ê°íˆ ê°ë‹¹í•  ìˆ˜ ì—†ëŠ” ì¡´ì¬ë“¤ì´ ì¦ë¹„í•˜ê³ , ëª©ìˆ¨ì„ ìœ„íƒœë¡­ê²Œ ë§Œë“œëŠ” ì•…ì˜ë“¤ì´ ê°€ë“í•©ë‹ˆë‹¤.</p>
    <p>ë‹¹ì‹ ì€ ê·¸ì¤‘ ë‹¨ ì²« ë²ˆì§¸ ë°©ì„ íƒˆì¶œí•œ ê²ƒì…ë‹ˆë‹¤.</p>
    <p>ê·¸ëŸ¼ì—ë„ ì²« ê´€ë¬¸ì„ ì´ê²¨ë‚¸ ì—¬ëŸ¬ë¶„ì—ê²Œ í™˜í˜¸ì˜ ë°•ìˆ˜ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.</p>
    <p>ì–´ë””ê¹Œì§€ ë„ë‹¬í•˜ì‹¤ ìˆ˜ ìˆì„ì§„ ëª¨ë¥´ê² ìœ¼ë‚˜, ì•„ë“í•œ ì € ì¶œêµ¬ë¥¼ í–¥í•´ í˜ê» ë…¸ë ¥í•´ ë³´ì‹œê¸¸ ë°”ë¼ëŠ” ë°”ì…ë‹ˆë‹¤.</p>
    <p>ì²« ë²ˆì§¸ ë°©ì„ íƒˆì¶œí•˜ì‹  íƒˆì¶œì ë¶„ë“¤ì€ ì•„ë˜ ë³´ì´ëŠ” ì½”ë©˜íŠ¸ë€ì— ìì‹ ì˜ ë§ì„ ë‹´ì„ ìê²©ì´ ì£¼ì–´ì§‘ë‹ˆë‹¤.</p>
    <p>ë¬´ìŠ¨ ë§ì„ í•´ë„ ë³¸ì¸ì˜ ììœ ì…ë‹ˆë‹¤. ë‹¨, ì‚¬íšŒì ìœ¼ë¡œ í†µìš©ë  ìˆ˜ ì—†ëŠ” ë¶€ì ì ˆ ë°œì–¸ì´ë‚˜ ì§€ë‚˜ì¹œ ì—¼ì„¸ì£¼ì˜ëŠ” í˜ë„í‹°ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <p class="note"><b>â€» ì½”ë©˜íŠ¸ëŠ” 1ì¸ 1íšŒë§Œ ì‘ì„± ê°€ëŠ¥í•˜ë©°, ì‘ì„± í›„ ìˆ˜ì •Â·ì‚­ì œëŠ” ë¶ˆê°€í•©ë‹ˆë‹¤.</b><br>
      ë‹¨ ìš´ì˜ìëŠ” ê´€ë¦¬ ì°¨ì›ì—ì„œ ì‚­ì œí•  ìˆ˜ ìˆìœ¼ë©°, ì´ ê²½ìš° ë²ˆí˜¸ëŠ” ë‹¹ê²¨ì§‘ë‹ˆë‹¤.</p>

    <div class="comments">
      <h2>ì½”ë©˜íŠ¸ë€</h2>

      <!-- í˜ì´ì§€ ë„¤ë¹„ (ìœ„) -->
      <div class="pager">
        <button id="prevBtn">ì´ì „</button>
        <span id="pageInfo">1 / 1</span>
        <button id="nextBtn">ë‹¤ìŒ</button>
      </div>

      <div id="commentList"></div>

      <!-- í˜ì´ì§€ ë„¤ë¹„ (ì•„ë˜) -->
      <div class="pager">
        <button id="prevBtn2">ì´ì „</button>
        <span id="pageInfo2">1 / 1</span>
        <button id="nextBtn2">ë‹¤ìŒ</button>
      </div>

      <form id="commentForm" onsubmit="return false">
        <textarea id="commentText" placeholder="ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 300ì)"></textarea>
        <div class="row">
          <button id="submitBtn">ì‘ì„±</button>
          <span class="note">ê³¼ë„í•œ ê³µë°±/ì œë¡œí­ ë¬¸ì/ë°˜ë³µ ë¬¸ìëŠ” ìë™ ì œê±°ë©ë‹ˆë‹¤.</span>
        </div>
      </form>

      <div id="adminHint" class="admin-hint" style="display:none">
        ê´€ë¦¬ì ëª¨ë“œ ON â€” ëŒ“ê¸€ ì˜† ğŸ—‘ ë²„íŠ¼ìœ¼ë¡œ ì‚­ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤ (Ctrl+Alt+Xë¡œ í•´ì œ)
      </div>
    </div>
  </div>

  <script>
    // ---------- ì„¤ì • ----------
    const PAGE_SIZE = 20;
    const ADMIN_TOKEN_KEY = 'admin_token'; // ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ í‚¤
    // --------------------------

    // ì—˜ë¦¬ë¨¼íŠ¸
    const listEl = document.getElementById('commentList');
    const formEl = document.getElementById('commentForm');
    const textEl = document.getElementById('commentText');
    const submitEl = document.getElementById('submitBtn');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfoEl = document.getElementById('pageInfo');

    const prevBtn2 = document.getElementById('prevBtn2');
    const nextBtn2 = document.getElementById('nextBtn2');
    const pageInfoEl2 = document.getElementById('pageInfo2');

    const adminHintEl = document.getElementById('adminHint');

    // ìƒíƒœ
    let page = 1;
    let totalPages = 1;

    // ìœ í‹¸
    const escapeHtml = (s) => String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'",'&#39;');

    const sanitize = (s) => String(s ?? '')
      // ì œë¡œí­ ë¬¸ì ì œê±°
      .replace(/[\u200B-\u200D\uFEFF]/g,'')
      // ì—°ì† ê³µë°± ì¶•ì†Œ
      .replace(/\s{3,}/g,' ')
      // ë™ì¼ ë¬¸ì 6íšŒ ì´ìƒ ë°˜ë³µ â†’ 6íšŒë¡œ ì¶•ì•½
      .replace(/(.)\1{6,}/g,(m, ch)=> ch.repeat(6))
      // ê¸´ ë‹¨ì–´(ê³µë°± ì—†ëŠ” 80ì ì´ìƒ) â†’ ì†Œí”„íŠ¸ í•˜ì´í”ˆ ì‚½ì…
      .replace(/(\S{80,})/g, m => m.match(/.{1,40}/g).join('\u00AD'))
      .trim();

    const isAdmin = () => !!sessionStorage.getItem(ADMIN_TOKEN_KEY);

    // ê´€ë¦¬ì í† ê¸€
    window.addEventListener('keydown', e=>{
      if(e.ctrlKey && e.altKey && (e.key==='a'||e.key==='A')){
        const pw = prompt('ìš´ì˜ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        if(!pw) return;
        sessionStorage.setItem(ADMIN_TOKEN_KEY, pw);
        adminHintEl.style.display = '';
        render();
        alert('ê´€ë¦¬ì ëª¨ë“œê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤.');
      }
      if(e.ctrlKey && e.altKey && (e.key==='x'||e.key==='X')){
        sessionStorage.removeItem(ADMIN_TOKEN_KEY);
        adminHintEl.style.display = 'none';
        render();
        alert('ê´€ë¦¬ì ëª¨ë“œê°€ êº¼ì¡ŒìŠµë‹ˆë‹¤.');
      }
    });

    // API
    async function fetchComments(pageNum=1){
      const r = await fetch(`/api/comments?page=${pageNum}&limit=${PAGE_SIZE}`, { headers:{ 'Accept':'application/json' }});
      if(!r.ok){
        let msg = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
        try{ const j = await r.json(); if(j && j.error) msg = j.error; }catch{}
        throw new Error(msg);
      }
      return await r.json();
    }

    // ë Œë”(ë²ˆí˜¸ ì¬ê³„ì‚°: í˜ì´ì§€ ê¸°ì¤€ ì ˆëŒ€ ìˆœë²ˆ)
    async function render(){
      try{
        const data = await fetchComments(page);
        totalPages = Math.max(1, Math.ceil((data.total||0) / (data.limit||PAGE_SIZE)));
        page = Math.min(Math.max(1, page), totalPages);

        listEl.innerHTML = '';

        const items = data.items || [];
        const base = ((data.page||1) - 1) * (data.limit||PAGE_SIZE); // 0-based
        items.forEach((c, i)=>{
          const displayNo = base + i + 1; // í™”ë©´í‘œì‹œìš© â€œíƒˆì¶œì Nâ€
          const row = document.createElement('div');
          row.className = 'comment';
          row.innerHTML = `
            <strong>[íƒˆì¶œì ${displayNo}]</strong> ${escapeHtml(c?.text ?? '')}
            ${ isAdmin() ? `<button class="delBtn" data-id="${c?.id ?? ''}" title="ì‚­ì œ">ğŸ—‘</button>` : '' }
          `;
          listEl.appendChild(row);
        });

        pageInfoEl.textContent  = `${page} / ${totalPages}`;
        pageInfoEl2.textContent = `${page} / ${totalPages}`;
        prevBtn.disabled = prevBtn2.disabled = (page <= 1);
        nextBtn.disabled = nextBtn2.disabled = (page >= totalPages);

        if(isAdmin()){
          adminHintEl.style.display = '';
          listEl.querySelectorAll('.delBtn').forEach(btn=>{
            btn.addEventListener('click', ()=> adminDelete(parseInt(btn.dataset.id,10)));
          });
        }else{
          adminHintEl.style.display = 'none';
        }
      }catch(err){
        listEl.innerHTML = `<p>ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${escapeHtml(String(err.message||err))}</p>`;
      }
    }

    // ì‘ì„±
    formEl.addEventListener('submit', async (e)=>{
      e.preventDefault();
      let text = sanitize(textEl.value);
      if(!text) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
      if(new Blob([text]).size > 2000) return alert('ë‚´ìš©ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤.');

      submitEl.disabled = true;
      try{
        const r = await fetch('/api/comments', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ text })
        });
        const j = await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(j.error || 'ë“±ë¡ ì‹¤íŒ¨');

        // ì„±ê³µ â†’ í˜„ì¬ í˜ì´ì§€ê°€ ë§ˆì§€ë§‰ì´ ì•„ë‹ˆë©´ ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì´ë™
        page = totalPages; // ëŒ€ì¶© ë§ˆì§€ë§‰ ê·¼ì²˜ë¡œ
        textEl.value = '';
        await render();
        // ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ í™•ì‹¤íˆ ì´ë™
        page = totalPages;
        await render();
        alert('ì½”ë©˜íŠ¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }catch(err){
        alert(err.message || 'ë“±ë¡ ì‹¤íŒ¨');
      }finally{
        submitEl.disabled = false;
      }
    });

    // ì‚­ì œ(ê´€ë¦¬ì)
    async function adminDelete(id){
      if(!id) return;
      if(!confirm('í•´ë‹¹ ì½”ë©˜íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”? (ë²ˆí˜¸ëŠ” ë‹¹ê²¨ì§‘ë‹ˆë‹¤)')) return;
      try{
        const token = sessionStorage.getItem(ADMIN_TOKEN_KEY) || '';
        const r = await fetch('/api/comments', {
          method:'DELETE',
          headers:{
            'Content-Type':'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ id })
        });
        const t = await r.text();
        if(!r.ok) throw new Error(t || 'ì‚­ì œ ì‹¤íŒ¨');

        // í˜„ì¬ í˜ì´ì§€ê°€ ë¹„ì–´ë²„ë ¸ë‹¤ë©´ í•œ í˜ì´ì§€ ì•ìœ¼ë¡œ
        if(listEl.children.length === 1 && page > 1) page -= 1;
        await render();
        alert('ì‚­ì œ ì™„ë£Œ');
      }catch(err){
        alert(err.message || 'ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    // í˜ì´ì§€ ì´ë™
    function goto(delta){
      page = Math.min(Math.max(1, page + delta), totalPages);
      render();
      window.scrollTo({top:0, behavior:'smooth'});
    }
    prevBtn.addEventListener('click', ()=> goto(-1));
    nextBtn.addEventListener('click', ()=> goto(+1));
    prevBtn2.addEventListener('click', ()=> goto(-1));
    nextBtn2.addEventListener('click', ()=> goto(+1));

    // ì´ˆê¸° ë Œë”
    render();
  </script>
</body>
</html>
