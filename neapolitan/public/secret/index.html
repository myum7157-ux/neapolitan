<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>첫 번째 방 탈출</title>

  <!-- 폰트: 제목=Song Myung, 본문=Nanum Pen Script(손글씨), 댓글=Poor Story(다른 손글씨) -->
  <link href="https://fonts.googleapis.com/css2?family=Song+Myung&family=Nanum+Pen+Script&family=Poor+Story&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#2b1b0e;
      --rule:#b89a6a;
      --paper-tint: rgba(255,255,255,.70);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:42px 18px;
      color:var(--ink);
      background:url('/images/parchment-bg.jpg') center/cover fixed no-repeat;
    }
    .wrap{
      width:min(820px, 96vw);
      margin:0 auto;
      background:var(--paper-tint);
      border:1px solid #af915f55;
      border-radius:12px;
      padding:28px 24px 26px;
      backdrop-filter: blur(1px);
    }

    /* 제목: 줄바꿈 두 줄, 다른 글꼴 */
    .title{
      font-family:'Song Myung', serif;
      letter-spacing:.02em;
      text-align:center;
      line-height:1.22;
      margin:0 0 18px;
    }
    .title .line1{ display:block; font-size:28px; }
    .title .line2{ display:block; font-size:26px; }

    /* 본문: 손글씨 느낌 */
    .body{
      font-family:'Nanum Pen Script', cursive;
      font-size:24px;
      line-height:1.55;
    }
    .body p{ margin:0 0 8px; }

    .note{
      margin-top:10px;
      font-family:'Nanum Pen Script', cursive;
      font-size:20px;
      color:#7a5c24;
    }

    /* 코멘트 */
    .comments{ margin-top:24px }
    .comments h2{
      font-family:'Song Myung', serif;
      font-size:22px; margin:0 0 10px;
      text-align:left;
    }
    #commentList .comment{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 0; border-bottom:1px solid var(--rule);
      font-family:'Poor Story', cursive; /* 댓글은 다른 손글씨 */
      font-size:20px;
    }
    #commentList .comment strong{ color:#4a2c1f }

    textarea{
      width:100%; min-height:92px; resize:vertical;
      padding:10px; border:1px solid var(--rule); border-radius:8px;
      font-family:'Poor Story', cursive; font-size:20px; background:#fffaf1;
    }
    button{
      margin-top:8px; padding:8px 14px; cursor:pointer;
      border:1px solid var(--rule); background:#f7efe2; border-radius:8px;
      font-family:'Song Myung', serif; font-size:16px;
    }
    .admin-hint{ font-size:12px; color:#866; opacity:.85; text-align:right; margin-top:6px }
    .delBtn{ margin-left:auto; background:#7b2a2a; color:#fff; border:none; padding:4px 8px; border-radius:6px; cursor:pointer }
    .hidden{ display:none }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">
      <span class="line1">축하드립니다.</span>
      <span class="line2">당신은 첫 번째 방을 탈출하셨습니다.</span>
    </h1>

    <div class="body">
      <p>하지만 당신도 아시다시피 본 게임은 그리 호락호락한 것이 아닙니다.</p>
      <p>당신께선 감히 감당할 수 없는 존재들이 즐비하고, 목숨을 위태롭게 만드는 악의들이 가득합니다.</p>
      <p>당신은 그중 단 첫 번째 방을 탈출한 것입니다.</p>
      <p>그럼에도 첫 관문을 이겨낸 여러분에게 환호의 박수를 보내드립니다.</p>
      <p>어디까지 도달하실 수 있을진 모르겠으나, 아득한 저 출구를 향해 힘껏 노력해 보시길 바라는 바입니다.</p>
      <p>첫 번째 방을 탈출하신 탈출자 분들은 아래 보이는 코멘트란에 자신의 말을 담을 자격이 주어집니다.</p>
      <p>무슨 말을 해도 본인의 자유입니다. 단, 사회적으로 통용될 수 없는 부적절 발언이나 지나친 염세주의는 페널티로 이어질 수 있습니다.</p>
      <p class="note"><b>※ 코멘트는 1인 1회만 작성 가능하며, 작성 후 수정·삭제는 불가합니다.</b><br>
        단 운영자는 관리 차원에서 삭제할 수 있으며, 이 경우 번호는 당겨집니다.</p>
    </div>

    <div class="comments">
      <h2>코멘트란</h2>
      <div id="commentList"></div>

      <form id="commentForm" onsubmit="return false">
        <textarea id="commentText" placeholder="코멘트를 입력하세요"></textarea><br>
        <button id="submitBtn">작성</button>
      </form>

      <div id="adminHint" class="admin-hint hidden">
        관리자 모드 ON — 댓글 옆 🗑 버튼으로 삭제 가능합니다 (Ctrl+Alt+X 끄기)
      </div>
    </div>
  </div>

  <script>
    // ==== 공통 ====
    const ADMIN_TOKEN_KEY = 'admin_token';
    let isAdmin = !!sessionStorage.getItem(ADMIN_TOKEN_KEY);

    const listEl   = document.getElementById('commentList');
    const formEl   = document.getElementById('commentForm');
    const textEl   = document.getElementById('commentText');
    const submitEl = document.getElementById('submitBtn');
    const adminHintEl = document.getElementById('adminHint');

    function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
    function setAdmin(on){ isAdmin = !!on; adminHintEl.classList.toggle('hidden', !isAdmin); render(); }

    // 관리자 토글: Ctrl+Alt+A (ON), Ctrl+Alt+X (OFF)
    window.addEventListener('keydown', e=>{
      if(e.ctrlKey && e.altKey && (e.key==='a'||e.key==='A')){
        const pw = prompt('운영자 비밀번호를 입력하세요');
        if(!pw) return;
        sessionStorage.setItem(ADMIN_TOKEN_KEY, pw);
        setAdmin(true);
        alert('관리자 모드가 켜졌습니다.');
      }
      if(e.ctrlKey && e.altKey && (e.key==='x'||e.key==='X')){
        sessionStorage.removeItem(ADMIN_TOKEN_KEY);
        setAdmin(false);
        alert('관리자 모드가 꺼졌습니다.');
      }
    });

    // ==== 목록 로드 ====
    async function fetchComments(){
      const r = await fetch('/api/comments');   // 복수형 경로
      if(!r.ok) throw new Error('목록 불러오기 실패');
      return await r.json();
    }

    async function render(){
      const data = await fetchComments().catch(err=>{
        listEl.innerHTML = `<p>불러오기 오류: ${escapeHtml(String(err.message||err))}</p>`;
        return [];
      });
      listEl.innerHTML = '';
      data.forEach(c=>{
        const row = document.createElement('div');
        row.className = 'comment';
        row.innerHTML = `
          <div><strong>[${c.by}]</strong> ${escapeHtml(c.text)}</div>
          ${isAdmin ? `<button class="delBtn" data-id="${c.id}" title="삭제">🗑</button>` : ''}
        `;
        listEl.appendChild(row);
      });
      if(isAdmin){
        listEl.querySelectorAll('.delBtn').forEach(btn=>{
          btn.addEventListener('click', ()=> adminDelete(parseInt(btn.dataset.id,10)));
        });
      }
    }

    // ==== 작성 (운영자 토큰 항상 부착) ====
    formEl.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = textEl.value.trim();
      if(!text) return alert('내용을 입력하세요.');
      submitEl.disabled = true;

      const headers = { 'Content-Type':'application/json' };
      const token = (sessionStorage.getItem(ADMIN_TOKEN_KEY) || '').trim();
      if(token) headers['Authorization'] = 'Bearer ' + token;

      const r = await fetch('/api/comments', {
        method:'POST',
        headers,
        body: JSON.stringify({ text })
      });

      if(r.ok){
        formEl.innerHTML = '<p style="font-family:\'Poor Story\',cursive;font-size:20px;">코멘트가 등록되었습니다.</p>';
        await render();
      }else{
        const err = await r.json().catch(()=>({}));
        alert(err.error || '등록 실패');
        submitEl.disabled = false;
      }
    });

    // ==== 운영자 삭제 ====
    async function adminDelete(id){
      if(!confirm(`탈출자 ${id}의 코멘트를 삭제할까요? (번호는 당겨집니다)`)) return;
      const token = (sessionStorage.getItem(ADMIN_TOKEN_KEY) || '').trim();
      const r = await fetch('/api/comments', {
        method:'DELETE',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer ' + token
        },
        body: JSON.stringify({ id })
      });
      if(r.ok){ alert('삭제 완료'); render(); }
      else{ alert('삭제 실패: ' + (await r.text())); }
    }

    // init
    if(isAdmin) adminHintEl.classList.remove('hidden');
    render();
  </script>
</body>
</html>
