<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>첫 번째 방 탈출</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --ink:#2b1b0e; --rule:#b89a6a; }
    *{box-sizing:border-box}
    body{
      margin:0; padding:40px;
      font-family:'Noto Serif KR',serif; line-height:1.65; color:var(--ink);
      background:url('/images/parchment-bg.jpg') center/cover fixed no-repeat;
    }
    .wrap{ max-width:760px; margin:0 auto; background:rgba(255,255,255,.72); border-radius:10px; padding:26px 22px; }
    h1{ text-align:center; font-size:26px; margin:0 0 18px }
    p{ margin:0 0 10px }
    .note{ font-size:13px; color:#7a5c24; margin-top:8px }
    .comments{ margin-top:28px }
    .comments h2{ font-size:20px; margin:0 0 10px }
    .comment{ display:flex; gap:8px; align-items:flex-start; padding:10px 0; border-bottom:1px solid var(--rule) }
    .comment strong{ color:#4a2c1f }
    textarea{ width:100%; height:100px; resize:vertical }
    button{ padding:7px 12px; cursor:pointer; border:1px solid var(--rule); background:#f7efe2; border-radius:6px }
    #pager{ margin-top:12px; display:flex; gap:6px; flex-wrap:wrap }
    #pager button[disabled]{opacity:.6}
    .muted{ color:#7a5c24; font-size:13px }
    .admin-hint{ font-size:12px; color:#866; opacity:.8; text-align:right; margin-top:6px }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>축하드립니다. 당신은 첫 번째 방을 성공적으로 탈출하셨습니다.</h1>
    <p>하지만 당신도 아시다시피 본 게임은 그리 호락호락한 것이 아닙니다.</p>
    <p>당신께선 감히 감당할 수 없는 존재들이 즐비하고, 목숨을 위태롭게 만드는 악의들이 가득합니다.</p>
    <p>당신은 그중 단 첫 번째 방을 탈출한 것입니다.</p>
    <p>그럼에도 첫 관문을 이겨낸 여러분에게 환호의 박수를 보내드립니다.</p>
    <p>어디까지 도달하실 수 있을진 모르겠으나, 아득한 저 출구를 향해 힘껏 노력해 보시길 바라는 바입니다.</p>
    <p>첫 번째 방을 탈출하신 탈출자 분들은 아래 보이는 코멘트란에 자신의 말을 담을 자격이 주어집니다.</p>
    <p>무슨 말을 해도 본인의 자유입니다. 단, 사회적으로 통용될 수 없는 부적절 발언이나 지나친 염세주의는 페널티로 이어질 수 있습니다.</p>
    <p class="note"><b>※ 코멘트는 1인 1회만 작성 가능하며, 작성 후 수정·삭제는 불가합니다.</b><br>단 운영자는 관리 차원에서 삭제할 수 있으며, 페이지는 번호가 당겨져 표시됩니다.</p>

    <div class="comments">
      <h2>코멘트란</h2>

      <div id="commentList"></div>
      <div id="pager"></div>
      <div class="muted" id="countInfo" style="margin-top:6px"></div>

      <form id="commentForm" onsubmit="return false" style="margin-top:12px">
        <textarea id="commentText" maxlength="300" placeholder="코멘트를 입력하세요 (최대 300자)"></textarea><br>
        <button id="submitBtn">작성</button>
      </form>

      <div class="admin-hint" id="adminHint" style="display:none">
        관리자 모드 — 삭제는 별도 관리 페이지에서 수행하세요.
      </div>
    </div>
  </div>

  <script>
    // ===== 클라이언트 스크립트 =====
    function esc(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
    function short(s,n=200){return s.length>n ? s.slice(0,n)+'…' : s;}

    const PAGE_SIZE = 20; // 한 페이지 개수(서버 limit와 맞추기)

    async function fetchComments(page=1){
      const r = await fetch(`/api/comments?page=${page}&limit=${PAGE_SIZE}`);
      if(!r.ok) throw new Error('목록 불러오기 실패');
      return await r.json();
    }

    function renderPager(cur, max){
      const pager = document.getElementById('pager');
      pager.innerHTML = '';
      if (max <= 1) return;

      // Prev
      const prev = document.createElement('button');
      prev.textContent = '‹ 이전';
      prev.disabled = (cur === 1);
      prev.onclick = () => loadComments(cur - 1);
      pager.appendChild(prev);

      for(let i=1;i<=max;i++){
        if (i===1 || i===max || Math.abs(i-cur)<=2){
          const btn = document.createElement('button');
          btn.textContent = i;
          if(i===cur) btn.disabled = true;
          btn.onclick = () => loadComments(i);
          pager.appendChild(btn);
        } else if ((i===2 && cur>4) || (i===max-1 && cur<max-3)) {
          const sep = document.createElement('span');
          sep.textContent = '…';
          sep.style.margin = '0 6px';
          pager.appendChild(sep);
          i = (i===2 ? cur-3 : max-1); // 점프
        }
      }

      // Next
      const next = document.createElement('button');
      next.textContent = '다음 ›';
      next.disabled = (cur === max);
      next.onclick = () => loadComments(cur + 1);
      pager.appendChild(next);
    }

    async function loadComments(page=1){
      const box = document.getElementById('commentList');
      box.innerHTML = '<p>로딩 중…</p>';

      const data = await fetchComments(page).catch(err=>{
        box.innerHTML = `<p>에러: ${esc(err.message)}</p>`;
        return {items:[],total:0,page:1,limit:PAGE_SIZE};
      });

      box.innerHTML = '';
      data.items.forEach((c,i)=>{
        // 표시용 번호(페이지 기준 연속)
        const num = (data.page-1)*data.limit + i + 1;
        const row = document.createElement('div');
        row.className = 'comment';
        row.innerHTML = `<div><strong>[탈출자 ${num}]</strong> ${esc(short(c.text))}</div>`;
        box.appendChild(row);
      });

      renderPager(data.page, Math.ceil(data.total / data.limit));
      document.getElementById('countInfo').textContent =
        `총 ${data.total}개 · 페이지 ${data.page}/${Math.max(1, Math.ceil(data.total / data.limit))}`;
    }

    // 작성
    document.getElementById('commentForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const ta = document.getElementById('commentText');
      const txt = ta.value.trim();
      if(!txt) return alert('내용을 입력하세요.');
      if(txt.length > 300) return alert('최대 300자까지 가능합니다.');

      const r = await fetch('/api/comments',{
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ text: txt })
      });
      if(r.ok){
        alert('코멘트가 등록되었습니다.');
        ta.value = '';
        // 첫 페이지 갱신
        loadComments(1);
        // 1인1회 정책이면 폼 비활성화
        document.getElementById('commentForm').innerHTML = '<p>코멘트가 등록되었습니다.</p>';
      }else{
        const err = await r.json().catch(()=>({}));
        alert(err.error || '등록 실패');
      }
    });

    // 첫 로드
    loadComments(1);
  </script>
</body>
</html>
