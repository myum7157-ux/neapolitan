<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>첫 번째 방 탈출</title>
  <style>
    body {
      margin:0;
      font-family: 'Noto Serif KR', serif;
      background: url('/images/parchment-bg.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #2b1b0e;
      line-height:1.6;
      padding:40px;
    }
    h1 { text-align:center; font-size:28px; margin-bottom:20px; }
    .content { max-width:720px; margin:0 auto; background:rgba(255,255,255,0.7); padding:24px; border-radius:8px; }
    .comments { margin-top:30px; }
    .comment { padding:8px 0; border-bottom:1px solid #b89a6a; display:flex; gap:8px; align-items:flex-start; }
    .comment strong { color:#4a2c1f; }
    .note { font-size:13px; color:#772; margin-bottom:8px; }
    textarea { width:100%; height:80px; }
    button { margin-top:8px; padding:6px 14px; cursor:pointer; }
    .admin-hint { font-size:12px; color:#995; opacity:.7; text-align:right; margin-top:8px; }
    .delBtn { margin-left:auto; background:#7b2a2a; color:#fff; border:none; padding:4px 8px; border-radius:4px; }
    .delBtn:hover { filter:brightness(1.05); }
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="content">
    <h1>축하드립니다. 당신은 첫 번째 방을 성공적으로 탈출하셨습니다.</h1>
    <p>
      하지만 당신도 아시다시피 본 게임은 그리 호락호락한 것이 아닙니다.<br>
      당신께선 감히 감당할 수 없는 존재들이 즐비하고, 목숨을 위태롭게 만드는 악의들이 가득합니다.<br>
      당신은 그중 단 첫 번째 방을 탈출한 것입니다.<br><br>
      그럼에도 첫 관문을 이겨낸 여러분에게 환호의 박수를 보내드립니다.<br>
      어디까지 도달하실 수 있을진 모르겠으나, 아득한 저 출구를 향해 힘껏 노력해 보시길 바라는 바입니다.<br><br>
      첫 번째 방을 탈출하신 탈출자 분들은 아래 보이는 코멘트란에 자신의 말을 담을 자격이 주어집니다.<br>
      무슨 말을 해도 본인의 자유입니다. 단, 사회적으로 통용될 수 없는 부적절 발언이나 지나친 염세주의는
      페널티로 이어질 수 있습니다.<br><br>
      <b>※ 코멘트는 1인 1회만 작성 가능하며, 작성 후 수정·삭제는 불가합니다.<br>
      단 운영자는 관리 차원에서 삭제할 수 있으며, 이 경우 번호는 당겨집니다.</b>
    </p>

    <div class="comments">
      <h2>코멘트란</h2>
      <div id="commentList"></div>
      <div id="form">
        <textarea id="commentText" placeholder="코멘트를 입력하세요"></textarea><br>
        <button id="submit">작성</button>
      </div>
      <div id="adminHint" class="admin-hint hidden">관리자 모드 ON — 댓글 옆 휴지통으로 삭제 가능</div>
    </div>
  </div>

  <script>
    // ===== 관리자 모드 토글 =====
    // Ctrl + Alt + A 누르면 비번 입력 → 토큰을 sessionStorage에 저장
    const ADMIN_TOKEN_KEY = 'admin_token';
    let isAdmin = false;

    function setAdmin(on){ 
      isAdmin = !!on;
      document.getElementById('adminHint').classList.toggle('hidden', !isAdmin);
      loadComments(); // 렌더 갱신(삭제 버튼 표시/숨김)
    }

    window.addEventListener('keydown', async (e)=>{
      if (e.ctrlKey && e.altKey && (e.key==='a' || e.key==='A')) {
        const pw = prompt('운영자 비밀번호를 입력하세요');
        if (!pw) return;
        // 토큰은 서버에서 OWNER_PASSWORD와 그대로 비교하니까
        // Authorization: Bearer <여기 입력한 pw> 를 그대로 씀
        sessionStorage.setItem(ADMIN_TOKEN_KEY, pw);
        setAdmin(true);
        alert('관리자 모드가 켜졌습니다.');
      }
      if (e.ctrlKey && e.altKey && (e.key==='x' || e.key==='X')) {
        sessionStorage.removeItem(ADMIN_TOKEN_KEY);
        setAdmin(false);
        alert('관리자 모드가 꺼졌습니다.');
      }
    });

    // ===== 코멘트 렌더링 =====
    async function loadComments() {
      const r = await fetch('/api/comments');
      const data = await r.json();
      const list = document.getElementById('commentList');
      list.innerHTML = '';
      data.forEach(c=>{
        const row = document.createElement('div');
        row.className='comment';
        row.innerHTML = `
          <div><strong>[${c.by}]</strong> ${escapeHtml(c.text)}</div>
          ${isAdmin ? `<button class="delBtn" data-id="${c.id}" title="삭제">🗑</button>` : '' }
        `;
        list.appendChild(row);
      });

      if (isAdmin) {
        list.querySelectorAll('.delBtn').forEach(btn=>{
          btn.addEventListener('click', ()=> adminDelete(parseInt(btn.dataset.id,10)));
        });
      }
    }

    // ===== 코멘트 작성 =====
    document.getElementById('submit').addEventListener('click', async ()=>{
      const text = document.getElementById('commentText').value.trim();
      if (!text) return alert("내용을 입력하세요.");
      const r = await fetch('/api/comments', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ text })
      });
      if (r.ok) {
        document.getElementById('form').innerHTML="<p>코멘트가 등록되었습니다.</p>";
        loadComments();
      } else {
        const err = await r.json().catch(()=>({}));
        alert(err.error || "등록 실패");
      }
    });

    // ===== 운영자 삭제 =====
    async function adminDelete(id){
      if (!confirm(`탈출자 ${id}의 코멘트를 삭제할까요? (번호는 당겨집니다)`)) return;
      const token = sessionStorage.getItem(ADMIN_TOKEN_KEY) || '';
      const r = await fetch('/api/comments', {
        method:'DELETE',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer ' + token
        },
        body: JSON.stringify({ id })
      });
      if (r.ok){
        alert('삭제 완료');
        loadComments();
      } else {
        const t = await r.text();
        alert('삭제 실패: ' + t);
      }
    }

    // XSS 방지용 일단 간단 escape
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    // 초기 상태: 토큰 있으면 자동 관리자 모드
    if (sessionStorage.getItem(ADMIN_TOKEN_KEY)) setAdmin(true);
    loadComments();
  </script>
</body>
</html>
