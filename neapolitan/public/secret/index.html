<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì²« ë²ˆì§¸ ë°© íƒˆì¶œ</title>
  <style>
    body {
      margin:0;
      font-family: 'Noto Serif KR', serif;
      background: url('/images/parchment-bg.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #2b1b0e;
      line-height:1.6;
      padding:40px;
    }
    h1 { text-align:center; font-size:28px; margin-bottom:20px; }
    .content { max-width:720px; margin:0 auto; background:rgba(255,255,255,0.7); padding:24px; border-radius:8px; }
    .comments { margin-top:30px; }
    .comment { padding:8px 0; border-bottom:1px solid #b89a6a; display:flex; gap:8px; align-items:flex-start; }
    .comment strong { color:#4a2c1f; }
    .note { font-size:13px; color:#772; margin-bottom:8px; }
    textarea { width:100%; height:80px; }
    button { margin-top:8px; padding:6px 14px; cursor:pointer; }
    .admin-hint { font-size:12px; color:#995; opacity:.7; text-align:right; margin-top:8px; }
    .delBtn { margin-left:auto; background:#7b2a2a; color:#fff; border:none; padding:4px 8px; border-radius:4px; }
    .delBtn:hover { filter:brightness(1.05); }
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="content">
    <h1>ì¶•í•˜ë“œë¦½ë‹ˆë‹¤. ë‹¹ì‹ ì€ ì²« ë²ˆì§¸ ë°©ì„ ì„±ê³µì ìœ¼ë¡œ íƒˆì¶œí•˜ì…¨ìŠµë‹ˆë‹¤.</h1>
    <p>
      í•˜ì§€ë§Œ ë‹¹ì‹ ë„ ì•„ì‹œë‹¤ì‹œí”¼ ë³¸ ê²Œì„ì€ ê·¸ë¦¬ í˜¸ë½í˜¸ë½í•œ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.<br>
      ë‹¹ì‹ ê»˜ì„  ê°íˆ ê°ë‹¹í•  ìˆ˜ ì—†ëŠ” ì¡´ì¬ë“¤ì´ ì¦ë¹„í•˜ê³ , ëª©ìˆ¨ì„ ìœ„íƒœë¡­ê²Œ ë§Œë“œëŠ” ì•…ì˜ë“¤ì´ ê°€ë“í•©ë‹ˆë‹¤.<br>
      ë‹¹ì‹ ì€ ê·¸ì¤‘ ë‹¨ ì²« ë²ˆì§¸ ë°©ì„ íƒˆì¶œí•œ ê²ƒì…ë‹ˆë‹¤.<br><br>
      ê·¸ëŸ¼ì—ë„ ì²« ê´€ë¬¸ì„ ì´ê²¨ë‚¸ ì—¬ëŸ¬ë¶„ì—ê²Œ í™˜í˜¸ì˜ ë°•ìˆ˜ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.<br>
      ì–´ë””ê¹Œì§€ ë„ë‹¬í•˜ì‹¤ ìˆ˜ ìˆì„ì§„ ëª¨ë¥´ê² ìœ¼ë‚˜, ì•„ë“í•œ ì € ì¶œêµ¬ë¥¼ í–¥í•´ í˜ê» ë…¸ë ¥í•´ ë³´ì‹œê¸¸ ë°”ë¼ëŠ” ë°”ì…ë‹ˆë‹¤.<br><br>
      ì²« ë²ˆì§¸ ë°©ì„ íƒˆì¶œí•˜ì‹  íƒˆì¶œì ë¶„ë“¤ì€ ì•„ë˜ ë³´ì´ëŠ” ì½”ë©˜íŠ¸ë€ì— ìì‹ ì˜ ë§ì„ ë‹´ì„ ìê²©ì´ ì£¼ì–´ì§‘ë‹ˆë‹¤.<br>
      ë¬´ìŠ¨ ë§ì„ í•´ë„ ë³¸ì¸ì˜ ììœ ì…ë‹ˆë‹¤. ë‹¨, ì‚¬íšŒì ìœ¼ë¡œ í†µìš©ë  ìˆ˜ ì—†ëŠ” ë¶€ì ì ˆ ë°œì–¸ì´ë‚˜ ì§€ë‚˜ì¹œ ì—¼ì„¸ì£¼ì˜ëŠ”
      í˜ë„í‹°ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>
      <b>â€» ì½”ë©˜íŠ¸ëŠ” 1ì¸ 1íšŒë§Œ ì‘ì„± ê°€ëŠ¥í•˜ë©°, ì‘ì„± í›„ ìˆ˜ì •Â·ì‚­ì œëŠ” ë¶ˆê°€í•©ë‹ˆë‹¤.<br>
      ë‹¨ ìš´ì˜ìëŠ” ê´€ë¦¬ ì°¨ì›ì—ì„œ ì‚­ì œí•  ìˆ˜ ìˆìœ¼ë©°, ì´ ê²½ìš° ë²ˆí˜¸ëŠ” ë‹¹ê²¨ì§‘ë‹ˆë‹¤.</b>
    </p>

    <div class="comments">
      <h2>ì½”ë©˜íŠ¸ë€</h2>
      <div id="commentList"></div>
      <div id="form">
        <textarea id="commentText" placeholder="ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea><br>
        <button id="submit">ì‘ì„±</button>
      </div>
      <div id="adminHint" class="admin-hint hidden">ê´€ë¦¬ì ëª¨ë“œ ON â€” ëŒ“ê¸€ ì˜† íœ´ì§€í†µìœ¼ë¡œ ì‚­ì œ ê°€ëŠ¥</div>
    </div>
  </div>

  <script>
    // ===== ê´€ë¦¬ì ëª¨ë“œ í† ê¸€ =====
    // Ctrl + Alt + A ëˆ„ë¥´ë©´ ë¹„ë²ˆ ì…ë ¥ â†’ í† í°ì„ sessionStorageì— ì €ì¥
    const ADMIN_TOKEN_KEY = 'admin_token';
    let isAdmin = false;

    function setAdmin(on){ 
      isAdmin = !!on;
      document.getElementById('adminHint').classList.toggle('hidden', !isAdmin);
      loadComments(); // ë Œë” ê°±ì‹ (ì‚­ì œ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€)
    }

    window.addEventListener('keydown', async (e)=>{
      if (e.ctrlKey && e.altKey && (e.key==='a' || e.key==='A')) {
        const pw = prompt('ìš´ì˜ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        if (!pw) return;
        // í† í°ì€ ì„œë²„ì—ì„œ OWNER_PASSWORDì™€ ê·¸ëŒ€ë¡œ ë¹„êµí•˜ë‹ˆê¹Œ
        // Authorization: Bearer <ì—¬ê¸° ì…ë ¥í•œ pw> ë¥¼ ê·¸ëŒ€ë¡œ ì”€
        sessionStorage.setItem(ADMIN_TOKEN_KEY, pw);
        setAdmin(true);
        alert('ê´€ë¦¬ì ëª¨ë“œê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤.');
      }
      if (e.ctrlKey && e.altKey && (e.key==='x' || e.key==='X')) {
        sessionStorage.removeItem(ADMIN_TOKEN_KEY);
        setAdmin(false);
        alert('ê´€ë¦¬ì ëª¨ë“œê°€ êº¼ì¡ŒìŠµë‹ˆë‹¤.');
      }
    });

    // ===== ì½”ë©˜íŠ¸ ë Œë”ë§ =====
    async function loadComments() {
      const r = await fetch('/api/comments');
      const data = await r.json();
      const list = document.getElementById('commentList');
      list.innerHTML = '';
      data.forEach(c=>{
        const row = document.createElement('div');
        row.className='comment';
        row.innerHTML = `
          <div><strong>[${c.by}]</strong> ${escapeHtml(c.text)}</div>
          ${isAdmin ? `<button class="delBtn" data-id="${c.id}" title="ì‚­ì œ">ğŸ—‘</button>` : '' }
        `;
        list.appendChild(row);
      });

      if (isAdmin) {
        list.querySelectorAll('.delBtn').forEach(btn=>{
          btn.addEventListener('click', ()=> adminDelete(parseInt(btn.dataset.id,10)));
        });
      }
    }

    // ===== ì½”ë©˜íŠ¸ ì‘ì„± =====
    document.getElementById('submit').addEventListener('click', async ()=>{
      const text = document.getElementById('commentText').value.trim();
      if (!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
      const r = await fetch('/api/comments', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ text })
      });
      if (r.ok) {
        document.getElementById('form').innerHTML="<p>ì½”ë©˜íŠ¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>";
        loadComments();
      } else {
        const err = await r.json().catch(()=>({}));
        alert(err.error || "ë“±ë¡ ì‹¤íŒ¨");
      }
    });

    // ===== ìš´ì˜ì ì‚­ì œ =====
    async function adminDelete(id){
      if (!confirm(`íƒˆì¶œì ${id}ì˜ ì½”ë©˜íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”? (ë²ˆí˜¸ëŠ” ë‹¹ê²¨ì§‘ë‹ˆë‹¤)`)) return;
      const token = sessionStorage.getItem(ADMIN_TOKEN_KEY) || '';
      const r = await fetch('/api/comments', {
        method:'DELETE',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer ' + token
        },
        body: JSON.stringify({ id })
      });
      if (r.ok){
        alert('ì‚­ì œ ì™„ë£Œ');
        loadComments();
      } else {
        const t = await r.text();
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + t);
      }
    }

    // XSS ë°©ì§€ìš© ì¼ë‹¨ ê°„ë‹¨ escape
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    // ì´ˆê¸° ìƒíƒœ: í† í° ìˆìœ¼ë©´ ìë™ ê´€ë¦¬ì ëª¨ë“œ
    if (sessionStorage.getItem(ADMIN_TOKEN_KEY)) setAdmin(true);
    loadComments();
  </script>
</body>
</html>
