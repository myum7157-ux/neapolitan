<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>첫 번째 방 탈출</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: url("/images/parchment-bg.jpg") no-repeat center center fixed;
      background-size: cover;
      font-family: 'Noto Serif KR', serif;
      color: #2b1b0f;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 40px 20px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
    }

    .container {
      max-width: 820px;
      background: rgba(255, 245, 225, 0.86);
      padding: 30px;
      border-radius: 12px;
      border: 1px solid rgba(50,20,0,0.4);
      box-shadow: 0 4px 25px rgba(0,0,0,0.6);
    }

    h1 {
      font-size: 26px;
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
    }

    p {
      line-height: 1.7;
      margin: 12px 0;
    }

    hr {
      border: 0;
      border-top: 1px solid rgba(0,0,0,.2);
      margin: 24px 0;
    }

    /* 코멘트 섹션 */
    .comments { margin-top: 20px; }
    .notice {
      font-size: 14px;
      color: #7a3a2a;
      margin-bottom: 10px;
    }
    .list { display: grid; gap: 12px; margin-top: 10px; }
    .item {
      border: 1px solid rgba(0,0,0,0.2);
      background: rgba(255,255,255,0.55);
      padding: 10px 14px;
      border-radius: 8px;
    }
    .meta { font-size: 13px; color: #553; margin-bottom: 6px; }
    .txt { white-space: pre-wrap; color:#1b140c; }

    form { margin-top: 14px; display: flex; flex-direction: column; gap: 10px; }
    textarea {
      resize: vertical;
      min-height: 80px;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #444;
      border-radius: 6px;
      font-family: 'Noto Serif KR', serif;
    }
    button {
      background: #5a1c1c;
      color: #fff;
      border: none;
      padding: 10px 14px;
      font-size: 15px;
      cursor: pointer;
      border-radius: 6px;
    }
    button:hover { background: #7a2a2a; }
    .status { font-size: 13px; color:#743; }
  </style>
</head>
<body>
  <div class="container">
    <h1>축하드립니다. 당신은 첫 번째 방을 성공적으로 탈출하셨습니다.</h1>

    <p>하지만 당신도 아시다시피 본 게임은 그리 호락호락한 것이 아닙니다.</p>
    <p>당신께선 감히 감당할 수 없는 존재들이 즐비하고, 목숨을 위태롭게 만드는 악의들이 가득합니다.</p>
    <p>당신은 그중 단 첫 번째 방을 탈출한 것입니다.</p>
    <p>그럼에도 첫 관문을 이겨낸 여러분에게 환호의 박수를 보내드립니다.</p>
    <p>어디까지 도달하실 수 있을진 모르겠으나, 아득한 저 출구를 향해 힘껏 노력해 보시길 바라는 바입니다.</p>
    <p>첫 번째 방을 탈출하신 탈출자 분들은 아래 보이는 코멘트란에 자신의 말을 담을 자격이 주어집니다.</p>
    <p>무슨 말을 해도 본인의 자유입니다. 단, 당신들의 종족인 인간들에게 있어 사회적으로 통용될 수 없는 부적절 발언,  
       혹은 지나치게 염세주의적인 코멘트를 남기신 탈출자들에겐 상응하는 페널티가 부여될 예정입니다.</p>
    <p>그럼 모쪼록, 앞으로도 게임을 즐겨주시길 바랍니다. 감사합니다.</p>

    <hr>

    <!-- 코멘트 영역 -->
    <section class="comments">
      <h2>코멘트란</h2>
      <p class="notice">※ 남기신 코멘트는 <b>수정·삭제가 불가능</b>합니다. 신중하게 작성해 주세요.</p>

      <form id="cform" autocomplete="off">
        <textarea id="ctext" maxlength="300" placeholder="여기에 코멘트를 남기세요. (최대 300자)" required></textarea>
        <button type="submit" id="cbtn">등록</button>
        <span id="cstatus" class="status"></span>
      </form>

      <div id="clist" class="list">
        <div class="item">코멘트를 불러오는 중…</div>
      </div>
    </section>
  </div>

  <script>
    const listEl = document.getElementById('clist');
    const formEl = document.getElementById('cform');
    const textEl = document.getElementById('ctext');
    const btnEl = document.getElementById('cbtn');
    const statusEl = document.getElementById('cstatus');

    const fmt = ts => {
      const d = new Date(ts); const z=n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
    };
    function renderItem(c){
      const el = document.createElement('div'); el.className='item';
      const meta = document.createElement('div'); meta.className='meta';
      meta.textContent = `[탈출자 ${c.n}] · ${fmt(c.t)}`;
      const txt = document.createElement('div'); txt.className='txt'; txt.innerText = c.text;
      el.append(meta, txt); return el;
    }

    async function loadComments(){
      try {
        const r = await fetch('/api/comment');
        const data = await r.json();
        listEl.innerHTML = '';
        if (!data.items || !data.items.length){
          listEl.innerHTML = '<div class="item">아직 코멘트가 없습니다.</div>';
        } else {
          data.items.forEach(c => listEl.appendChild(renderItem(c)));
        }
        if (data.already){
          statusEl.textContent = '이미 코멘트를 남기셨습니다.';
          textEl.disabled = true; btnEl.disabled = true;
        }
      } catch(e){
        listEl.innerHTML = '<div class="item">불러오기 오류</div>';
      }
    }

    formEl.addEventListener('submit', async e=>{
      e.preventDefault();
      const text = textEl.value.trim();
      if (!text) return;
      btnEl.disabled = true; statusEl.textContent = '등록 중…';
      try {
        const r = await fetch('/api/comment', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        });
        const data = await r.json();
        if (r.ok && data.ok){
          listEl.appendChild(renderItem(data.item));
          statusEl.textContent = '등록되었습니다. (수정·삭제 불가)';
          textEl.value=''; textEl.disabled = true; btnEl.disabled = true;
        } else {
          statusEl.textContent = data.message || '등록 실패';
          if (data.already){ textEl.disabled = true; btnEl.disabled = true; }
        }
      } catch(e){
        statusEl.textContent = '네트워크 오류';
      } finally {
        if (!textEl.disabled) btnEl.disabled = false;
      }
    });

    loadComments();
  </script>
</body>
</html>
