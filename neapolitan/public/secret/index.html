<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>탈출 — 첫 번째 방</title>
<link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700&family=IM+Fell+English:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#221a14; --ink2:#3b2b1f; --muted:#6e5845;
    --paper: #f1e1c2;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink); background:#0b0906; display:flex; place-content:center; min-height:100%;
    font-family:"Nanum Myeongjo", serif; line-height:1.85;
  }
  /* parchment board */
  .sheet{
    position:relative; width:min(920px, 94vw); margin:28px 12px 90px; padding:46px 26px 34px;
    background:var(--paper) url("./parchment.jpg") center/cover no-repeat;
    box-shadow: 0 40px 90px rgba(0,0,0,.5);
    border-radius: 6px;
    filter: contrast(0.95) saturate(0.93);
  }
  /* vignette & grain */
  .sheet:before, .sheet:after{content:""; position:absolute; inset:0; pointer-events:none;}
  .sheet:before{
    background: radial-gradient(120% 140% at 50% 30%, rgba(0,0,0,0) 55%, rgba(0,0,0,.42) 100%);
    mix-blend-mode:multiply; border-radius:6px;
  }
  .sheet:after{
    opacity:.16; mix-blend-mode:multiply;
    background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 10 10'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2'/></filter><rect width='10' height='10' filter='url(%23n)'/></svg>");
    animation:noise 1s steps(2) infinite;
    border-radius:6px;
  }
  @keyframes noise{to{transform:translate(-8px,6px)}}

  .inner{position:relative; z-index:1}

  h1{
    font-family:"IM Fell English", serif;
    font-size: clamp(22px, 3.6vw, 34px);
    letter-spacing:.02em; margin:0 0 12px; color:var(--ink2);
  }
  p{margin:0 0 14px}
  hr{border:0; border-top:1px solid rgba(0,0,0,.15); margin:18px 0}

  /* comments */
  .c-wrap{margin-top:10px}
  .c-head{display:flex; align-items:flex-end; justify-content:space-between; gap:12px}
  .c-head h2{margin:0; font-size:18px; font-weight:700; color:#3a2a1f}
  .tip{color:#8b6f58; font-size:13px}
  .c-form textarea{
    width:100%; min-height:120px; padding:10px 12px; border-radius:8px;
    background:rgba(255,255,255,.55); border:1px solid rgba(0,0,0,.18);
    font-family:"Nanum Myeongjo",serif; resize:vertical; color:#1a120b;
  }
  .row{display:flex; gap:10px; align-items:center; margin-top:10px}
  .btn{
    padding:9px 14px; border:0; border-radius:8px; cursor:pointer;
    background:#2a1b12; color:#efe7db;
  }
  .btn[disabled]{opacity:.6; cursor:default}
  .status{color:#6b4a36; font-size:13px}
  .list{margin-top:16px; display:grid; gap:10px}
  .item{
    border:1px solid rgba(0,0,0,.2); background:rgba(255,255,255,.45);
    border-radius:10px; padding:10px 12px; backdrop-filter:blur(1px);
  }
  .meta{display:flex; gap:8px; font-size:12px; color:#5a4030}
  .nick{font-weight:700}
  .txt{white-space:pre-wrap; margin-top:6px; color:#1d140e}
  .empty{color:#8b6f58; font-size:14px}
</style>
</head>
<body>
  <main class="sheet">
    <div class="inner">
      <h1>축하드립니다. 당신은 첫 번째 방을 성공적으로 탈출하셨습니다.</h1>

      <p>하지만 당신도 아시다시피 본 게임은 그리 호락호락한 것이 아닙니다.</p>
      <p>당신께선 감히 감당할 수 없는 존재들이 즐비하고, 목숨을 위태롭게 만드는 악의들이 가득합니다.</p>
      <p>당신은 그중 단 첫 번째 방을 탈출한 것입니다.</p>
      <p>그럼에도 첫 관문을 이겨낸 여러분에게 환호의 박수를 보내드립니다.</p>
      <p>어디까지 도달하실 수 있을진 모르겠으나, 아득한 저 출구를 향해 힘껏 노력해 보시길 바라는 바입니다.</p>
      <p>첫 번째 방을 탈출하신 탈출자 분들은 아래 보이는 코멘트란에 자신의 말을 담을 자격이 주어집니다.</p>
      <p>무슨 말을 해도 본인의 자유입니다. 단, 당신들의 종족인 인간들에게 있어 사회적으로 통용될 수 없는 부적절 발언,</p>
      <p>혹은 지나치게 염세주의적인 코멘트를 남기신 탈출자들에겐 상응하는 페널티가 부여될 예정입니다.</p>
      <p>그럼 모쪼록, 앞으로도 게임을 즐겨주시길 바랍니다.</p>
      <p>감사합니다.</p>

      <hr>

      <!-- 코멘트 -->
      <section class="c-wrap">
        <div class="c-head">
          <h2>코멘트 (1인 1회)</h2>
          <span class="tip">닉네임은 자동으로 “탈출자 N” 으로 부여됩니다. (최대 300자)</span>
        </div>

        <form id="cform" autocomplete="off" class="c-form">
          <textarea id="ctext" maxlength="300" placeholder="여기에 당신의 말을 남기세요. 등록 후 수정/삭제 불가"></textarea>
          <div class="row">
            <button class="btn" id="cbtn" type="submit">등록</button>
            <span id="cstatus" class="status"></span>
          </div>
        </form>

        <div id="clist" class="list">
          <div class="empty">코멘트를 불러오는 중…</div>
        </div>
      </section>
    </div>
  </main>

<script>
const listEl = document.getElementById('clist');
const formEl = document.getElementById('cform');
const textEl = document.getElementById('ctext');
const btnEl = document.getElementById('cbtn');
const statusEl = document.getElementById('cstatus');

const fmt = ts => {
  const d = new Date(ts); const z=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
};
function renderItem(c){
  const el = document.createElement('div'); el.className='item';
  const meta = document.createElement('div'); meta.className='meta';
  const nick = document.createElement('span'); nick.className='nick'; nick.textContent = `[${c.nick}]`;
  const time = document.createElement('span'); time.textContent = `· ${fmt(c.t)}`;
  meta.append(nick, time);
  const txt = document.createElement('div'); txt.className='txt'; txt.innerText = c.text; // XSS 방지
  el.append(meta, txt); return el;
}

async function loadComments(){
  try{
    const r = await fetch('/api/comment?limit=50',{credentials:'same-origin'});
    const data = await r.json();
    listEl.innerHTML = '';
    if (!data.items || data.items.length===0){
      listEl.innerHTML = '<div class="empty">아직 코멘트가 없습니다.</div>';
    } else {
      data.items.forEach(c => listEl.appendChild(renderItem(c)));
    }
    if (data.already){
      statusEl.textContent = '이미 코멘트를 남기셨습니다.';
      textEl.disabled = true; btnEl.disabled = true;
    }
  }catch(e){
    listEl.innerHTML = '<div class="empty">코멘트를 불러오지 못했습니다.</div>';
  }
}

formEl.addEventListener('submit', async e=>{
  e.preventDefault();
  const text = textEl.value.trim();
  if (!text) return;
  btnEl.disabled = true; statusEl.textContent = '등록 중…';
  try{
    const r = await fetch('/api/comment', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ text }),
      credentials:'same-origin'
    });
    const data = await r.json();
    if (r.ok && data.ok){
      statusEl.textContent = '등록되었습니다.';
      textEl.value=''; textEl.disabled = true; btnEl.disabled = true;
      listEl.prepend(renderItem(data.item));
    }else{
      statusEl.textContent = data.message || '등록 실패';
      if (data.already){ textEl.disabled = true; btnEl.disabled = true; }
    }
  }catch(e){
    statusEl.textContent = '오류가 발생했습니다.';
  }finally{
    if (!textEl.disabled) btnEl.disabled = false;
  }
});

loadComments();
</script>
</body>
</html>

