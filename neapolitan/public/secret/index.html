<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>첫 번째 방 탈출</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --ink:#2b1b0e; --rule:#b89a6a; }
    *{box-sizing:border-box}
    body{
      margin:0; padding:40px;
      font-family:'Noto Serif KR',serif; line-height:1.65; color:var(--ink);
      background:url('/images/parchment-bg.jpg') center/cover fixed no-repeat;
    }
    .wrap{ max-width:720px; margin:0 auto; background:rgba(255,255,255,.72); border-radius:10px; padding:26px 22px; }
    h1{ text-align:center; font-size:26px; margin:0 0 18px }
    p{ margin:0 0 10px }
    .note{ font-size:13px; color:#7a5c24; margin-top:8px }
    .comments{ margin-top:26px }
    .comments h2{ font-size:20px; margin:0 0 10px }
    .comment{ padding:12px 10px; border-bottom:1px solid var(--rule); word-wrap:break-word; overflow-wrap:anywhere; }
    .comment strong{ color:#4a2c1f }
    textarea{ width:100%; height:100px; resize:vertical }
    button{ padding:7px 14px; cursor:pointer; border:1px solid var(--rule); background:#f7efe2 }
    .admin-hint{ font-size:12px; color:#866; opacity:.8; text-align:right; margin-top:6px }
    .delBtn{ float:right; background:#7b2a2a; color:#fff; border:none; padding:3px 7px; border-radius:4px }
    .hidden{ display:none }
    .pager{ display:flex; gap:6px; justify-content:center; align-items:center; margin:14px 0 }
    .pager button{ padding:6px 10px }
    .count{ font-size:12px; color:#7a5c24; text-align:right; margin-top:4px }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>축하드립니다. 당신은 첫 번째 방을 성공적으로 탈출하셨습니다.</h1>
    <p>하지만 당신도 아시다시피 본 게임은 그리 호락호락한 것이 아닙니다.</p>
    <p>당신께선 감히 감당할 수 없는 존재들이 즐비하고, 목숨을 위태롭게 만드는 악의들이 가득합니다.</p>
    <p>당신은 그중 단 첫 번째 방을 탈출한 것입니다.</p>
    <p>그럼에도 첫 관문을 이겨낸 여러분에게 환호의 박수를 보내드립니다.</p>
    <p>어디까지 도달하실 수 있을진 모르겠으나, 아득한 저 출구를 향해 힘껏 노력해 보시길 바라는 바입니다.</p>
    <p>첫 번째 방을 탈출하신 탈출자 분들은 아래 보이는 코멘트란에 자신의 말을 담을 자격이 주어집니다.</p>
    <p>무슨 말을 해도 본인의 자유입니다. 단, 사회적으로 통용될 수 없는 부적절 발언이나 지나친 염세주의는 페널티로 이어질 수 있습니다.</p>
    <p class="note"><b>※ 코멘트는 1인 1회만 작성 가능하며, 작성 후 수정·삭제는 불가합니다.</b><br>
      단 운영자는 관리 차원에서 삭제할 수 있으며, 이 경우 번호는 당겨집니다.</p>

    <div class="comments">
      <h2>코멘트란</h2>

      <div id="commentList"></div>

      <!-- pagination -->
      <div class="pager">
        <button id="prevBtn">이전</button>
        <span id="pageInfo"></span>
        <button id="nextBtn">다음</button>
      </div>

      <form id="commentForm" onsubmit="return false">
        <textarea id="commentText" placeholder="코멘트를 입력하세요 (최대 300자)"></textarea>
        <div class="count" id="charCount">0 / 300</div>
        <button id="submitBtn">작성</button>
      </form>

      <div id="adminHint" class="admin-hint hidden">
        관리자 모드 ON — 댓글 옆 🗑 버튼으로 삭제 가능합니다
      </div>
    </div>
  </div>

  <script>
    // ==== 설정 ====
    const API = '/api/comments';
    const PAGE_SIZE = 20;
    const MAX_LEN = 300;

    // ==== 상태 ====
    let page = 1;
    let totalPages = 1;

    // ==== 요소 ====
    const listEl = document.getElementById('commentList');
    const pageInfoEl = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const formEl = document.getElementById('commentForm');
    const textEl = document.getElementById('commentText');
    const countEl = document.getElementById('charCount');
    const submitEl = document.getElementById('submitBtn');
    const adminHintEl = document.getElementById('adminHint');

    // ==== 관리자 모드 토글 (Ctrl+Alt+K ON / Ctrl+Alt+L OFF) ====
    const ADMIN_TOKEN_KEY = 'admin_token';
    function isAdmin(){ return !!sessionStorage.getItem(ADMIN_TOKEN_KEY); }
    function setAdminUI(){ adminHintEl.classList.toggle('hidden', !isAdmin()); render(); }
    window.addEventListener('keydown', e=>{
      if(e.ctrlKey && e.altKey && (e.key==='k'||e.key==='K')){
        const pw = prompt('운영자 비밀번호를 입력하세요'); if(!pw) return;
        sessionStorage.setItem(ADMIN_TOKEN_KEY, pw); setAdminUI(); alert('관리자 모드 ON');
      }
      if(e.ctrlKey && e.altKey && (e.key==='l'||e.key==='L')){
        sessionStorage.removeItem(ADMIN_TOKEN_KEY); setAdminUI(); alert('관리자 모드 OFF');
      }
    });

    // ==== 유틸: 안전 이스케이프 (null/undefined 방어) ====
    function escapeHtml(s){
      if(typeof s !== 'string') return '';
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ==== 목록 불러오기 ====
    async function fetchComments(p=1){
      const r = await fetch(`${API}?page=${p}&limit=${PAGE_SIZE}`, { headers:{ 'Cache-Control':'no-cache' }});
      if(!r.ok) throw new Error('목록 불러오기 실패');
      return await r.json();
    }

    async function render(){
      try{
        const data = await fetchComments(page);
        totalPages = Math.max(1, Math.ceil((data.total||0)/PAGE_SIZE));
        page = Math.min(Math.max(1, page), totalPages);

        listEl.innerHTML = '';
        (data.items || []).forEach(c=>{
          const d = document.createElement('div');
          d.className = 'comment';
          const by = escapeHtml(c?.by || `탈출자 ${c?.id ?? '?'}`);
          const txt = escapeHtml(c?.text || '');
          d.innerHTML = `
            <strong>[${by}]</strong> ${txt}
            ${ isAdmin() ? `<button class="delBtn" data-id="${c?.id ?? ''}" title="삭제">🗑</button>` : '' }
          `;
          listEl.appendChild(d);
        });

        pageInfoEl.textContent = `${page} / ${totalPages}`;
        prevBtn.disabled = (page<=1);
        nextBtn.disabled = (page>=totalPages);

        if(isAdmin()){
          listEl.querySelectorAll('.delBtn').forEach(btn=>{
            btn.addEventListener('click', ()=> adminDelete(parseInt(btn.dataset.id,10)));
          });
        }
      }catch(err){
        listEl.innerHTML = `<p>불러오기 오류: ${escapeHtml(String(err.message||err))}</p>`;
      }
    }

    // 페이지 이동
    prevBtn.addEventListener('click', ()=>{ if(page>1){ page--; render(); }});
    nextBtn.addEventListener('click', ()=>{ if(page<totalPages){ page++; render(); }});

    // 글자수 표시 및 클라이언트 측 길이 제한
    function updateCount(){
      const t = textEl.value || '';
      if(t.length > MAX_LEN){
        textEl.value = t.slice(0, MAX_LEN);
      }
      countEl.textContent = `${textEl.value.length} / ${MAX_LEN}`;
    }
    textEl.addEventListener('input', updateCount);

    // 작성
    formEl.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = (textEl.value || '').trim();
      if(!text) return alert('내용을 입력하세요.');
      submitEl.disabled = true;

      try{
        const r = await fetch(API, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ text })
        });
        const data = await r.json().catch(()=>({}));
        if(r.ok){
          formEl.innerHTML = '<p>코멘트가 등록되었습니다.</p>';
          // 최신 페이지로 이동해 다시 로드 (원하는 경우 page = totalPages 로 갱신)
          page = totalPages; 
          render();
        }else{
          alert(data.error || '등록 실패');
          submitEl.disabled = false;
        }
      }catch(err){
        alert('네트워크 오류: ' + (err?.message || err));
        submitEl.disabled = false;
      }
    });

    // 운영자 삭제
    async function adminDelete(id){
      if(!id) return;
      if(!confirm(`탈출자 ${id}의 코멘트를 삭제할까요? (번호는 당겨집니다)`)) return;
      const token = sessionStorage.getItem(ADMIN_TOKEN_KEY) || '';
      const r = await fetch(API, {
        method:'DELETE',
        headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
        body: JSON.stringify({ id })
      });
      if(r.ok){
        alert('삭제 완료');
        // 현재 페이지에서 항목이 모두 지워졌다면 한 페이지 앞으로
        if(listEl.children.length === 1 && page>1) page--;
        render();
      }else{
        const msg = await r.text();
        alert('삭제 실패: ' + msg);
      }
    }

    // init
    setAdminUI();
    updateCount();
    render();
  </script>
</body>
</html>
